#!/bin/sh
# :*:setting up EFEU
# :de:Basisinitialisierung von EFEU
#
# Copyright (C) 2001 Erich Frühstück
# This file is part of EFEU.
# 
# EFEU is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public
# License as published by the Free Software Foundation; either
# version 2 of the License, or (at your option) any later version.
# 
# EFEU is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty
# of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public
# License along with EFEU; see the file COPYING.
# If not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.

# get top directory (absolut path needed)

if [ $# -ge 1 ]; then
	top=$1
else
	top="../.."
fi

top=`(cd $top; pwd)`
gen_note="Do not edit, file created by "`pwd`"/setup"

# create bin directory

bin=$top/bin

if [ ! -d $bin ]; then
	mkdir $bin || exit 1
fi

# install basic scripts

for x in mksrclist efeubuild efeugen efeuscript
do
	cp base/$x.sh $bin/$x || exit 1
	chmod a+x $bin/$x
done

# create efeutop command

cat > $top/bin/efeutop << !
#!/bin/sh
# $gen_note
echo $top
!

chmod a+x $top/bin/efeutop

# determine C compiler

CC=cc

if [ -f /usr/bin/gcc ]; then
	CC="gcc -fPIC -Wall -Wmissing-prototypes -D_GNU_SOURCE"

	case `uname -m` in
	i[456]86)
		CC="$CC -O -m486"
		;;
	esac
else
	case `uname -s` in
	AIX)
		CC="xlc -qsrcmsg -D_ALL_SOURCE"
		;;
	esac
fi

# test compiler

tmp=${TMPDIR:-/tmp}/cf$$
trap "rm -f $tmp*" 0
trap "exit 1" 1 2 3

cat > $tmp.c << !
#include <stdio.h>

int main (void)
{
#if	__STDC__
	return 0;
#else
	return 1;
#endif
}
!

$CC -o $tmp $tmp.c || { echo "$0: C compiler not available"; exit 1; }
$tmp || { echo "$0: EFEU needs ANSI C compiler"; exit 1; }
rm -f $tmp $tmp.c

# create efeucc command

cat > $top/bin/efeucc << !
#!/bin/sh
# $gen_note
LD_RUN_PATH="\$LD_RUN_PATH:$top/lib"; export LD_RUN_PATH
exec $CC -D_EFEU_TOP=$top -I$top/include -L$top/lib \$@
!

chmod a+x $top/bin/efeucc

