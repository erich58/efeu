#!/bin/sh
# :*:check Gtk+ implementation
# :de:Überprüfe die Gtk+ Implementation
#
# Copyright (C) 2001 Erich Frühstück
# This file is part of EFEU.
# 
# EFEU is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public
# License as published by the Free Software Foundation; either
# version 2 of the License, or (at your option) any later version.
# 
# EFEU is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty
# of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public
# License along with EFEU; see the file COPYING.
# If not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.

# check gtk-config

gtk-config --version > /dev/null || (
	echo "Please check your Gtk+ installation."
	exit 1 )

# get top directory (absolut path needed)

if [ $# -ge 1 ]; then
	top=$1
else
	top="../.."
fi

top=`(cd $top; pwd)`
src=`pwd`

cfdir=$top/ppinclude

if [ ! -d $cfdir ]; then
	mkdir -p $cfdir || exit 1
fi

cfname=$cfdir/gtk.pph

cat > $cfname.tmp << !
/*
:*:configuration file for Gtk+ programms
:de:Konfigurationsdatei für Gtk+ Programme
\$Note
:*:Do not edit this file, it was created by $src/setup
:de:Diese Datei nicht editieren, sie wurde mit $src/setup generiert.
*/

!

echo "GTKINC=" `gtk-config --cflags` >> $cfname.tmp
echo "GTKLIB=" `gtk-config --libs` >> $cfname.tmp

if	cmp -s $cfname.tmp $cfname
then	rm $cfname.tmp
else	mv $cfname.tmp $cfname
fi

cat $cfname

# check implementation

tmp=${TMPDIR:-/tmp}/gtk$$
trap "rm -rf $tmp" 0
trap "exit 1" 1 2 3

mkdir $tmp || exit 1
grep '^GTK' $cfname > $tmp/Makefile
cat >> $tmp/Makefile <<!
tprog: tprog.c; \$(CC) \$(GTKINC) -o \$@ tprog.c \$(GTKLIB)
!

cat >> $tmp/tprog.c << !
#include <gtk/gtk.h>

int main (int argc, char **argv)
{
	gtk_init(&argc, &argv);
	return 0;
}
!

if
	(cd $tmp; make > log.out 2>&1)
then
	exit 0
fi

echo "$0: project configuration failed"
echo "--- make rules ---"
nl $tmp/Makefile
echo "--- test program ---"
nl $tmp/tprog.c
echo "--- error message ---"
nl $tmp/log.out
exit 1
