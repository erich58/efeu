#!/bin/sh
# :*:check PostgreSQL implementation
# :de:Überprüfe die PostgreSQL implementation
#
# Copyright (C) 2001 Erich Frühstück
# This file is part of EFEU.
# 
# EFEU is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public
# License as published by the Free Software Foundation; either
# version 2 of the License, or (at your option) any later version.
# 
# EFEU is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty
# of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public
# License along with EFEU; see the file COPYING.
# If not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.

# configuration parameters

incpath="/usr/include /usr/local/include"

# get top directory (absolut path needed)

if [ $# -ge 1 ]; then
	top=$1
else
	top="../.."
fi

top=`(cd $top; pwd)`
src=`pwd`

# search header

cfdir=$top/ppinclude
cfname=$cfdir/libpq.pph
hdr="libpq-fe.h"

path=`find $incpath -name $hdr -print | sed -e 1q`

if	[ "$path" = "" ]; then
	echo "$0: header file $hdr not found."
	echo "Please check your PostgreSQL installation."
	exit 1
else
	incdir=`dirname $path`
fi

if
	grep -q "void.*PQputline" $path
then
	echo "$0: Version of libpq seems to be to old."
	exit 1
fi

if [ ! -d $cfdir ]; then
	mkdir -p $cfdir || exit 1
fi

libs="-lpq"

if [ -f /usr/lib/libcrypt.so ]; then
	libs="$libs -lcrypt"
fi

cat > $cfname.tmp << !
/*
:*:configuration file for PostgreSQL interface
:de:Konfigurationsdatei für PostgreSQL Schnittstelle
\$Note
:*:Do not edit this file, it was created by $src/setup
:de:Diese Datei nicht editieren, sie wurde mit $src/setup generiert.
*/

PQINC= -I$incdir
PQLIB= $libs
!

if	cmp -s $cfname.tmp $cfname
then	rm $cfname.tmp
else	mv $cfname.tmp $cfname
fi

# check implementation

tmp=${TMPDIR:-/tmp}/pq$$
trap "rm -rf $tmp" 0
trap "exit 1" 1 2 3

mkdir $tmp || exit 1
grep '^PQ' $cfname > $tmp/Makefile
cat >> $tmp/Makefile <<!
tprog: tprog.c; \$(CC) \$(PQINC) -o \$@ tprog.c \$(PQLIB)
!

cat >> $tmp/tprog.c << !
#include <libpq-fe.h>

int main (int argc, char **argv)
{
	PQfinish(PQconnectdb(NULL));
	return 0;
}
!

if
	(cd $tmp; make > log.out 2>&1)
then
	exit 0
else
	echo "$0: project configuration failed"
	echo "--- make rules ---"
	nl $tmp/Makefile
	echo "--- test program ---"
	nl $tmp/tprog.c
	echo "--- error message ---"
	nl $tmp/log.out
	exit 1
fi
